# Copyright 2024 The Sigstore Authors
# SPDX-License-Identifier: Apache-2.0

name: deploy-terraform

on:
  push:
    branches:
      - "main"
  workflow_dispatch:

concurrency: deploy
permissions: {}

jobs:
  deploy:
    runs-on: ubuntu-latest

    if: github.repository == 'sigstore/sigstore-devops-tools'

    permissions:
      contents: read  # clone the repository contents
      id-token: write # federates with GCP

    steps:
    - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      with:
        persist-credentials: false
    - uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6.2.0
      with:
        go-version-file: './go.mod'
        check-latest: true

    - uses: google-github-actions/auth@7c6bc770dae815cd3e89ee6cdf493a5fab2cc093 # v3.0.0
      id: auth
      with:
        workload_identity_provider: "projects/801815070094/locations/global/workloadIdentityPools/tooling-pool/providers/github-actions-provider"
        service_account: "github-actions@sigstore-support-tooling.iam.gserviceaccount.com"

    # Attempt to deploy the terraform configuration
    - name: Detect version of Terraform needed
      id: version
      run: |
          go install github.com/hashicorp/terraform-config-inspect@latest
          echo "terraform-version=$(terraform-config-inspect --json ${GITHUB_WORKSPACE}/iac | jq -r .required_core[0])" >> "$GITHUB_OUTPUT"

    - uses: hashicorp/setup-terraform@5e8dbf3c6d9deaf4193ca7a8fb23f2ac83bb6c85 # v4.0.0
      with:
        terraform_version: ${{ steps.version.outputs.terraform-version }}
        terraform_wrapper: false

    - working-directory: ./iac
      run: |
        terraform init

        terraform plan -out=plan.out

        terraform apply -auto-approve "plan.out"

    - uses: rtCamp/action-slack-notify@e31e87e03dd19038e411e38ae27cbad084a90661 # v2.3.3
      if: ${{ failure() }}
      env:
        SLACK_ICON: http://github.com/chainguard-dev.png?size=48
        SLACK_USERNAME: guardian
        SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
        SLACK_CHANNEL: 'sigstore-devops-tools-alerts' # Use a channel
        SLACK_COLOR: '#8E1600'
        MSG_MINIMAL: 'true'
        SLACK_TITLE: Deploying sigstore-devops-tools failed
        SLACK_MESSAGE: |
          For detailed logs: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
